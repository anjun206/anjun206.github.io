<script>
  // YML -> JS (이름 -> URL)
  window.EMOJI_MAP = {{ site.data.emojis | jsonify }};

  (function () {
    // 🔧 프리셋 정의: 기본 크기/테두리
    var PRESETS = {
      emoji:  { size: '1.1em', radius: '0' },   // 기본
      emoji2: { size: '8em', radius: '0' },  // 살짝 더 큼
      emoji3: { size: '12em',  radius: '0' }   // 더 큼
    };

    function makeEmojiSpan(src, size, alt, radius) {
      var span = document.createElement('span');
      span.className = 'emoji';
      span.style.display = 'inline-block';
      span.style.width = size;
      span.style.height = size;
      span.style.verticalAlign = '-0.15em';
      span.style.overflow = 'hidden';
      span.style.borderRadius = radius || '0';
      span.style.lineHeight = '1';

      var img = new Image();
      img.className = 'emoji-img';
      img.src = src;
      img.alt = alt || '';
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      img.style.display = 'block';
      img.style.isolation = 'auto'; // 헤더와 겹침 방지

      span.appendChild(img);
      return span;
    }

    // href/scheme에서 프리셋과 인자 파싱
    // 예: emoji:marie_smile, 1.2em, 0.2em  (size, radius는 선택)
    //     emoji2:marie_smile
    function parseSpec(href, labelFallback) {
      var m = href.match(/^(emoji\d*):(.+)$/i);
      var scheme = (m ? m[1] : (labelFallback || 'emoji')).toLowerCase();
      var specRaw = m ? m[2] : href;

      var preset = PRESETS[scheme] || PRESETS.emoji;

      var parts = specRaw.split(',').map(function (s) { return s.trim(); }).filter(Boolean);
      return {
        nameOrUrl: parts[0],
        size:   parts[1] || preset.size,
        radius: parts[2] || preset.radius,
        scheme: scheme
      };
    }

    function upgradeEmojiLinks() {
      // 1) 권장: href에 스킴 사용 (emoji:, emoji2:, emoji3:)
      var nodes = document.querySelectorAll('a[href^="emoji"]');
      nodes.forEach(function (a) {
        var parsed = parseSpec(a.getAttribute('href'), (a.textContent || '').trim().toLowerCase());
        var key = parsed.nameOrUrl;
        var src = (window.EMOJI_MAP && window.EMOJI_MAP[key]) || key; // 이름 없으면 URL로 취급
        var alt = a.getAttribute('title') || key;
        a.replaceWith(makeEmojiSpan(src, parsed.size, alt, parsed.radius));
      });

      // 2) 보너스: [emoji2](marie_smile, 1.4em) 처럼 스킴 없이 쓴 경우
      var fallback = document.querySelectorAll('a:not([href^="http"]):not([href^="/"]):not([href^="#"])');
      fallback.forEach(function (a) {
        var label = (a.textContent || '').trim().toLowerCase(); // emoji/emoji2/emoji3
        if (PRESETS[label]) {
          var parts = (a.getAttribute('href') || '').split(',').map(function (s) { return s.trim(); }).filter(Boolean);
          var key = parts[0];
          var size = parts[1] || PRESETS[label].size;
          var radius = parts[2] || PRESETS[label].radius;
          var src = (window.EMOJI_MAP && window.EMOJI_MAP[key]) || key;
          a.replaceWith(makeEmojiSpan(src, size, key, radius));
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', upgradeEmojiLinks);
    } else {
      upgradeEmojiLinks();
    }
  })();
</script>
