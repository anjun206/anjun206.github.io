<script>
  // YML -> JS (ì´ë¦„ -> URL)
  window.EMOJI_MAP = {{ site.data.emojis | jsonify }};

  (function () {
    // ğŸ”§ í”„ë¦¬ì…‹ ì •ì˜: ê¸°ë³¸ í¬ê¸°/í…Œë‘ë¦¬
    var PRESETS = {
      emoji:  { size: '1.1em', radius: '0' },   // ê¸°ë³¸
      emoji2: { size: '8em', radius: '0' },  // ì‚´ì§ ë” í¼
      emoji3: { size: '12em',  radius: '0' }   // ë” í¼
    };

    function makeEmojiSpan(src, size, alt, radius) {
      var span = document.createElement('span');
      span.className = 'emoji';
      span.style.display = 'inline-block';
      span.style.width = size;
      span.style.height = size;
      span.style.verticalAlign = '-0.15em';
      span.style.overflow = 'hidden';
      span.style.borderRadius = radius || '0';
      span.style.lineHeight = '1';

      var img = new Image();
      img.className = 'emoji-img';
      img.src = src;
      img.alt = alt || '';
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      img.style.display = 'block';
      img.style.isolation = 'auto'; // í—¤ë”ì™€ ê²¹ì¹¨ ë°©ì§€

      span.appendChild(img);
      return span;
    }

    // href/schemeì—ì„œ í”„ë¦¬ì…‹ê³¼ ì¸ì íŒŒì‹±
    // ì˜ˆ: emoji:marie_smile, 1.2em, 0.2em  (size, radiusëŠ” ì„ íƒ)
    //     emoji2:marie_smile
    function parseSpec(href, labelFallback) {
      var m = href.match(/^(emoji\d*):(.+)$/i);
      var scheme = (m ? m[1] : (labelFallback || 'emoji')).toLowerCase();
      var specRaw = m ? m[2] : href;

      var preset = PRESETS[scheme] || PRESETS.emoji;

      var parts = specRaw.split(',').map(function (s) { return s.trim(); }).filter(Boolean);
      return {
        nameOrUrl: parts[0],
        size:   parts[1] || preset.size,
        radius: parts[2] || preset.radius,
        scheme: scheme
      };
    }

    function upgradeEmojiLinks() {
      // 1) ê¶Œì¥: hrefì— ìŠ¤í‚´ ì‚¬ìš© (emoji:, emoji2:, emoji3:)
      var nodes = document.querySelectorAll('a[href^="emoji"]');
      nodes.forEach(function (a) {
        var parsed = parseSpec(a.getAttribute('href'), (a.textContent || '').trim().toLowerCase());
        var key = parsed.nameOrUrl;
        var src = (window.EMOJI_MAP && window.EMOJI_MAP[key]) || key; // ì´ë¦„ ì—†ìœ¼ë©´ URLë¡œ ì·¨ê¸‰
        var alt = a.getAttribute('title') || key;
        a.replaceWith(makeEmojiSpan(src, parsed.size, alt, parsed.radius));
      });

      // 2) ë³´ë„ˆìŠ¤: [emoji2](marie_smile, 1.4em) ì²˜ëŸ¼ ìŠ¤í‚´ ì—†ì´ ì“´ ê²½ìš°
      var fallback = document.querySelectorAll('a:not([href^="http"]):not([href^="/"]):not([href^="#"])');
      fallback.forEach(function (a) {
        var label = (a.textContent || '').trim().toLowerCase(); // emoji/emoji2/emoji3
        if (PRESETS[label]) {
          var parts = (a.getAttribute('href') || '').split(',').map(function (s) { return s.trim(); }).filter(Boolean);
          var key = parts[0];
          var size = parts[1] || PRESETS[label].size;
          var radius = parts[2] || PRESETS[label].radius;
          var src = (window.EMOJI_MAP && window.EMOJI_MAP[key]) || key;
          a.replaceWith(makeEmojiSpan(src, size, key, radius));
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', upgradeEmojiLinks);
    } else {
      upgradeEmojiLinks();
    }
  })();
</script>
